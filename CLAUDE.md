# CLAUDE.md

## 0) Project snapshot (最重要)
- 目的: **大人が無料で、スキマ時間に、1戦だけ**気軽に遊べるゲームマッチングWebアプリ
- 想定: インターネット公開のWebアプリ（悪用・荒れ対策が必須）
- ルール:
  - **1戦限定**
  - **VCなし**
  - アプリ内チャットは「集合・開始調整」用途に限定（雑談SNS化しない）
- ゴール: 「参加 → マッチ → 連絡 → 解散」までを最短で回す
- 非ゴール（v1）:
  - Elo/ランク精密保証
  - 長文コミュニティ/SNS機能
  - 画像/ファイル送信、外部リンク自由化（荒れやすいので後回し）

---

## 1) あなた（Claude Code）への作業方針
- まずリポジトリを走査して、**既存の設計・規約・lint/testコマンドを最優先**する
- 大きい変更の前に、必ず **小さな計画(5〜10行) → 実装 → テスト** の順で進める
- 「動くが危ない」を避ける（公開Webのため **安全/悪用耐性/運用性を優先**）
- 依存追加は最小限。追加するなら理由と代替案がない旨を短く残す
- 既存のフォーマッタ/リンタ設定に従う（Prettier/ESLint/Ruff等）

---

## 2) v1の必須機能（MVP）
### ユーザ体験
- 匿名〜簡易ログイン（推奨: OAuth/メールリンク等。パスワード運用は後回し）
- マッチ募集作成（ゲーム/地域・サーバ/開始可能時刻/希望ロール等）
- 自動 or ほぼ自動のマッチ成立（待機中の相手と組む）
- **マッチ成立ルーム**（最小チャット＋集合情報）
- 1戦後にルーム自動クローズ（＋簡易フィードバック: 👍/👎、通報、ブロック）

### 運用・安全
- レート制限（募集/チャット/ログイン/通報）
- 通報・ブロック
- 監視（エラー/遅延/マッチ成立率など最低限のメトリクス）

---

## 3) プライバシー/データ保持（公開Webのため必須）
- **チャットは短命**: 既定 24時間で自動削除（必要なら 1〜6時間まで短縮）
- 収集する個人情報は最小（メール等は必要最小限、プロフィールは任意）
- ログに個人情報・チャット本文を出さない（デバッグ時もマスク）
- ゲームアカウントの「認証情報」は扱わない（ID表示は任意・本人入力）

---

## 4) セキュリティ / 悪用対策（最低ライン）
- 入力バリデーション（長さ、文字種、NGワード、URL投稿制限）
- XSS対策（基本はエスケープ徹底。Markdownは無効か、強制サニタイズ）
- CSRF/セッション管理（Cookie利用時はSameSite等）
- 連投/スパム対策（IP/アカウント単位のレート制限、必要ならCAPTCHA）
- 管理画面は最小でも強固な認可（可能ならIP制限）

---

## 5) 推奨リポジトリ構成（例）
※実際の構成が異なる場合は、**この節を現状に合わせて更新**すること。

- `apps/web/` : フロント（Next.js等）
- `apps/api/` : API（Next.js Route Handler or FastAPI等）
- `packages/shared/` : 共有型/バリデーション/ドメインモデル
- `docs/` : 仕様・意思決定ログ（ADR）

---

## 6) 開発コマンド（エージェント用の優先順位）
エージェントは **存在するファイルで自動判定**してコマンドを選ぶこと。

### Node/TypeScript がある場合（`package.json` がある）
- Install: `pnpm install`（pnpmが無ければnpm/yarnに読み替え）
- Dev: `pnpm dev`
- Lint: `pnpm lint`
- Test: `pnpm test`
- Typecheck: `pnpm typecheck`
- Build: `pnpm build`

### Python がある場合（`pyproject.toml` がある）
- Install: `uv sync`（uvが無ければ `pip install -r requirements.txt` 等に読み替え）
- Dev: `uv run uvicorn app.main:app --reload`
- Test: `uv run pytest -q`
- Lint/Format: `uv run ruff check .` / `uv run ruff format .`

### DB を使う場合（Postgres推奨）
- ローカル起動は `docker compose up -d` を優先（ある場合）
- マイグレーションは「新規追加のみ」。既存の適用済みを改変しない

---

## 7) コーディング規約（短く・強制）
- public API は OpenAPI/型で境界を明確化
- 変更にはテストを添える（特にマッチング/権限/レート制限）
- 例外/エラーは握りつぶさず、ユーザ向けメッセージ＋内部ログを分離
- 追加する設定値（TTLや制限値など）は env/config に寄せ、直書きしない

---

## 8) マッチング仕様（MVP指針）
- 目的は「最速で成立」：複雑なスコアリングよりシンプル優先
- 例: 同一ゲーム & 同一地域 & 希望時間が近い（±15分）を優先
- 同条件が複数なら「待機時間が長い順」
- 成立後はルーム作成 → 双方に状態遷移（**idempotent**に実装）

---

## 9) Definition of Done（完了条件）
- `lint` / `test` / `typecheck` が通る
- 主要フローが手元で確認できる（募集→成立→チャット→クローズ）
- ルーム/チャットの自動期限切れが動く
- レート制限が最低1箇所以上（募集 or チャット）に入っている
- 変更点を `docs/` or README に1段落で追記

## 10) E2Eテスト
- `playwright`を用いて、正常系のE2Eテストを実装してください
- E2Eテストコードは必要に応じて適宜修正してください。

## 11) コード管理
- GitHubで管理
- 動作する単位でCommitを作成
- 基本的にGitHub CLIを利用すること